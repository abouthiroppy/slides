<!DOCTYPE html><html lang="en"><head><meta http-equiv="Content-type" content="text/html; charset=utf-8"><meta name="theme-color" content="#3498db"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Introducing top-level-await</title><meta property="og:title" content="Introducing top-level-await"><meta property="og:type" content="article"><meta property="og:site_name" content="hiroppy's slides"><link href="vendor.6.0103e2df9e401919d36d.css" rel="stylesheet"><link href="main.3.598e67bb6c173a352d54.css" rel="stylesheet"></head><body><div id="root"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" class="btn-sidebar" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg><article id="webslides"><section class="aligncenter title"><h1>Introducing top-level-await</h1><br><p><a href="https://github.com/hiroppy/slides">https://github.com/hiroppy/slides</a></p></section><section class="aligncenter"><pre><code class="language-js">import { process } from &#x27;./some-module.js&#x27;;

const dynamic = import(computedModuleSpecifier);
const data = fetch(url);

//                             üëá                      üëá
export const output = process((await dynamic).default, await data);
</code></pre><p><a href="https://github.com/tc39/proposal-top-level-await">https://github.com/tc39/proposal-top-level-await</a></p></section><section class="aligncenter"><h2>Variants</h2><br><p>A / B / C(dropped. to the optional constraint)</p><br><p><strong>Currently, TLA refers to <code>variant B</code>.</strong></p><br><ul><li>Variant A: TLA blocks tree execution</li><li>Variant B: TLA doesn&#x27;t block sibling execution</li></ul></section><section class="aligncenter"><pre><code class="language-js">import a from &#x27;./a.js&#x27;; // this module has TLA
import b from &#x27;./b.js&#x27;; // this module has TLA
import c from &#x27;./c.js&#x27;; // this module has TLA

console.log(a, b, c);

// --------------------------------------------
// Execution Order
async function main() {
  // reduce startup time
  const [a, b, c] = await Promise.all([import(&#x27;./a.mjs&#x27;), import(&#x27;./b.mjs&#x27;), import(&#x27;./c.mjs&#x27;)]);

  // it won&#x27;t be like this(this is variant A)
  // const a = await import(&#x27;./a.js&#x27;);
  // const b = await import(&#x27;./b.js&#x27;);
  // const c = await import(&#x27;./c.js&#x27;);
}
</code></pre><p>TLA wouldn&#x27;t block execution in the graph until it had resolved but blocks execution of child nodes in the graph.</p><p>TLA occurs during the execution phase of the module graph so all resources have already been fetched and linked.</p><br><p><a href="https://v8.dev/features/top-level-await#module-execution-order">here for details</a></p></section><section class="aligncenter"><h2>Deadlocks</h2><br><p>Pay attention to Circular Module Dependencies.<br><!-- -->Both modules using TLA halt progress until the other finishes loading.</p><br><pre><code class="language-js">// ---------- a.js ----------
await import(&#x27;b&#x27;);

// implement a hoistable then() to prevent cycles while a module is still evaluating.
export function then(f, r) {
  r(&#x27;not finished&#x27;);
};

// remove the rejection
then = null;

// üôÖ‚Äç‚ôÄÔ∏è---------- b.js ----------
await import(&#x27;a&#x27;);

// üôÜ‚Äç‚ôÄÔ∏è ---------- b.js ----------
let a;

try {
  a = await import(&#x27;a&#x27;);
} catch {
  // do something
}
</code></pre></section><section class="aligncenter"><h2>Userlands</h2><br><ul><li>V8@7.9.49</li><li>webpack@5.0.0-alpha.15</li></ul></section><section class="aligncenter"><h2>webpack@next</h2><pre><code class="language-js">// ---------- webpack.config.js ----------
module.exports = {
  experiments: {
    topLevelAwait: true,
    importAwait: true,
    importAsync: true,
    asyncWebAssembly: true
  }
};

// ---------- db-connection.js ----------
export const dbCall = async data =&gt; {
  await new Promise(r =&gt; setTimeout(r, 100));
  return &#x27;fake data&#x27;;
};

// ---------- main.js ----------
import await { dbCall } from &#x27;./db-connection.js&#x27;;
// or const { dbCall } = import(&#x27;./db-connection.js&#x27;);

const { createUser } = await UserApi;
</code></pre><p><code>db-connection.js</code> is <strong>an async module</strong> and async modules have different evaluation semantics.</p><p>Async modules can&#x27;t imported with a normal import. They need to be imported with <code>import await</code>.</p><p><code>import()</code> doesn&#x27;t care about whether a module is an async module or not.</p></section><section class="aligncenter"><h2>References</h2><br><ul><li><a href="https://github.com/tc39/proposal-top-level-await">tc39/proposal-top-level-await</a></li><li><a href="https://v8.dev/features/top-level-await">Top-level await ¬∑ V8</a></li><li><a href="https://github.com/webpack/webpack/pull/9177">Top-level-await, new WASM modules and async modules based on import await and import async</a></li></ul></section><section class="aligncenter end"><h1>The End</h1><br><div class="sns-list sns-list-end"><a href="https://hiroppy.me" target="_blank"><i class="fas fa-home"></i></a><a href="https://twitter.com/about_hiroppy" target="_blank"><i class="fab fa-twitter"></i></a><a href="https://github.com/hiroppy" target="_blank"><i class="fab fa-github"></i></a><a href="https://www.facebook.com/abouthiroppy" target="_blank"><i class="fab fa-facebook"></i></a><a href="https://www.linkedin.com/in/hiroppy" target="_blank"><i class="fab fa-linkedin"></i></a></div></section></article></div><script type="text/javascript" src="runtime.62e438fcd270a05103cc.bundle.js"></script><script type="text/javascript" src="vendor.6.0103e2df9e401919d36d.bundle.js"></script><script type="text/javascript" src="main.3.598e67bb6c173a352d54.bundle.js"></script></body></html>